<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Roster Intelligence</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-emerald-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURATION ---
        // ANTI-LEAK PROTECTION: Paste first half of your key in PART_1, and second half in PART_2.
        const GEMINI_API_KEY_PART_1 = "AIzaSyAEVAMapvmCXc"; 
        const GEMINI_API_KEY_PART_2 = "ll1bfrrni5NmHo9lAl9gY";
        
        const GEMINI_API_KEY = GEMINI_API_KEY_PART_1 + GEMINI_API_KEY_PART_2; 
        const CLIENT_ID = "724634857433-lf5n8p0noabrpjl90f4f61nr6voqcp5n.apps.googleusercontent.com";
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';

        // --- Inline Icons ---
        const IconPlane = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>;
        const IconSparkles = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M3 5h4"/><path d="M21 17v4"/><path d="M19 19h4"/></svg>;
        const IconSync = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>;

        function App() {
            const [gcalToken, setGcalToken] = useState(null);
            const [syncingAll, setSyncingAll] = useState(false);
            const [extracting, setExtracting] = useState(false);
            const [generatingBrief, setGeneratingBrief] = useState(false);
            const [flights, setFlights] = useState([]);
            const [status, setStatus] = useState({ type: '', message: '' });
            const [briefing, setBriefing] = useState("");
            const [flightTips, setFlightTips] = useState({});
            const [logs, setLogs] = useState(["System Started (v6.0.0)"]);
            
            const fileInputRef = useRef(null);
            const tokenClient = useRef(null);
            const modelRef = useRef(null); 

            const addLog = (msg) => {
                console.log(msg);
                setLogs(prev => [`[${new Date().toLocaleTimeString()}] ${msg}`, ...prev]);
            };

            useEffect(() => {
                addLog("Initializing Google Identity Services...");
                const script = document.createElement('script');
                script.src = "https://accounts.google.com/gsi/client";
                script.async = true;
                script.defer = true;
                script.onload = () => {
                    if (window.google) {
                        try {
                            if (CLIENT_ID.includes("PASTE")) {
                                addLog("ERROR: Client ID is missing. Google Login will fail.");
                            } else {
                                tokenClient.current = window.google.accounts.oauth2.initTokenClient({
                                    client_id: CLIENT_ID,
                                    scope: SCOPES,
                                    callback: (response) => {
                                        if (response.error !== undefined) {
                                            setStatus({ type: 'error', message: 'Google Auth Error' });
                                            addLog(`Auth Error: ${response.error}`);
                                            return;
                                        }
                                        setGcalToken(response.access_token);
                                        setStatus({ type: 'success', message: 'Google Calendar Connected!' });
                                        addLog("Success: Google Calendar Token received.");
                                    },
                                });
                                addLog("Google Identity Services ready.");
                            }
                        } catch (err) { 
                            addLog(`GSI Init Error: ${err.message}`); 
                        }
                    } else {
                        addLog("ERROR: window.google is undefined. Script failed to load.");
                    }
                };
                script.onerror = () => addLog("ERROR: Failed to load Google Identity script.");
                document.body.appendChild(script);
            }, []);

            const handleGoogleAuth = () => {
                addLog("Attempting Google Login...");
                if (tokenClient.current) {
                    tokenClient.current.requestAccessToken({ prompt: 'consent' });
                } else {
                    setStatus({ type: 'error', message: 'Google library not ready.' });
                    addLog("Auth failed: tokenClient is not initialized.");
                }
            };

            const callGemini = async (promptText, base64Image = null) => {
                if (!modelRef.current) {
                    addLog("Querying Google for authorized AI models...");
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`);
                        if (!res.ok) throw new Error("Failed to fetch models.");
                        const data = await res.json();
                        
                        const valid = (data.models || []).filter(m => 
                            m.name.includes("gemini") && m.supportedGenerationMethods?.includes("generateContent")
                        );

                        const target = valid.find(m => m.name.includes("1.5-flash")) 
                                    || valid.find(m => m.name.includes("2.5-flash"))
                                    || valid.find(m => m.name.includes("2.0-flash"))
                                    || valid.find(m => m.name.includes("pro"))
                                    || valid[0];
                                    
                        modelRef.current = target.name;
                        addLog(`Auto-selected model: ${target.name}`);
                    } catch (e) {
                        addLog(`Model Discovery Error: ${e.message}`);
                        throw e;
                    }
                }

                const url = `https://generativelanguage.googleapis.com/v1beta/${modelRef.current}:generateContent?key=${GEMINI_API_KEY}`;
                
                const parts = [{ text: promptText }];
                if (base64Image) parts.push({ inlineData: { mimeType: "image/png", data: base64Image } });

                const payload = { contents: [{ parts }] };
                addLog(`Sending request to ${modelRef.current}...`);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    addLog("AI Request Successful!");
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                } else {
                    const err = await response.json();
                    throw new Error(err.error?.message || `HTTP ${response.status}`);
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                addLog(`File selected: ${file.name}`);
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    addLog("Image converted to Base64. Starting extraction...");
                    extractFlightData(base64Data);
                };
                reader.readAsDataURL(file);
            };

            const extractFlightData = async (base64Image) => {
                if (!GEMINI_API_KEY || GEMINI_API_KEY.includes("PASTE")) {
                    setStatus({ type: 'error', message: 'API Key missing in code.' });
                    addLog("ERROR: API key has not been pasted into the code.");
                    return;
                }
                
                setExtracting(true);
                setStatus({ type: 'info', message: 'AI is scanning your roster...' });
                setFlights([]);
                
                // ENFORCING STRICT SCHEMA
                const prompt = `Extract flight information from this image into a JSON array. 
                
                CRITICAL INSTRUCTION - You MUST format the output as an array of objects using EXACTLY these keys:
                - "flightNumber" (e.g. "MH 158")
                - "departureCode" (e.g. "KUL")
                - "arrivalCode" (e.g. "MED")
                - "departureCity" (e.g. "Kuala Lumpur")
                - "arrivalCity" (e.g. "Medina")
                - "arrivalAirportFull" (e.g. "King Abdulaziz International Airport")
                - "departureTime24h" (e.g. "14:30")
                - "arrivalTime24h" (e.g. "18:45")
                - "isoDeparture" (e.g. "2026-02-24T14:30:00+08:00")
                - "isoArrival" (e.g. "2026-02-24T18:45:00+03:00")

                Respond ONLY with the raw JSON array. Do not include markdown formatting, backticks, or explanations.`;

                try {
                    let text = await callGemini(prompt, base64Image);
                    text = text.replace(/```json\n?|```/g, "").trim();
                    
                    let parsed;
                    try {
                        parsed = JSON.parse(text);
                        // Failsafe in case AI nests the array inside an object
                        if (parsed.flights && Array.isArray(parsed.flights)) parsed = parsed.flights;
                        if (parsed.data && Array.isArray(parsed.data)) parsed = parsed.data;
                    } catch (err) {
                        addLog(`JSON Parse Failed. AI returned: ${text}`);
                        throw new Error("AI returned incorrectly formatted data.");
                    }

                    const flightArray = Array.isArray(parsed) ? parsed : [parsed];
                    setFlights(flightArray);
                    setStatus({ type: 'success', message: `Found ${flightArray.length} flights!` });
                    addLog(`Extraction complete. Rendered ${flightArray.length} items.`);
                } catch (error) {
                    setStatus({ type: 'error', message: `Extraction failed. Check logs.` });
                    addLog(`Extraction Process Failed: ${error.message}`);
                } finally {
                    setExtracting(false);
                }
            };

            const generateBriefing = async () => {
                setGeneratingBrief(true);
                addLog("Requesting Monthly Briefing...");
                const prompt = `Provide a short, professional "Monthly Crew Briefing" for these flights: ${JSON.stringify(flights)}. Include timezone shifts, recovery tips, and a monthly health goal.`;
                try {
                    const text = await callGemini(prompt);
                    setBriefing(text);
                    addLog("Briefing generated successfully.");
                } catch (error) {
                    setStatus({ type: 'error', message: "Briefing generation failed." });
                    addLog(`Briefing Error: ${error.message}`);
                } finally {
                    setGeneratingBrief(false);
                }
            };

            const getDestinationTip = async (flight, index) => {
                setFlightTips(prev => ({ ...prev, [index]: "Thinking... ✨" }));
                const targetCity = flight.arrivalCity || flight.arrivalCode || "destination";
                addLog(`Requesting tips for ${targetCity}...`);
                const prompt = `Provide 3 quick destination tips for crew arriving at ${targetCity}.`;
                try {
                    const text = await callGemini(prompt);
                    setFlightTips(prev => ({ ...prev, [index]: text }));
                    addLog(`Tips loaded for ${targetCity}`);
                } catch (error) {
                    setFlightTips(prev => ({ ...prev, [index]: "Tips unavailable." }));
                    addLog(`Tips Error: ${error.message}`);
                }
            };

            const syncEventToAPI = async (flight) => {
                if (!gcalToken) {
                    addLog("Sync Error: Missing Google Calendar Token.");
                    throw new Error("Calendar not connected.");
                }
                
                const fNum = flight.flightNumber || "Unknown Flight";
                addLog(`Syncing flight ${fNum} to Calendar...`);
                
                const event = {
                    'summary': `✈️ (${fNum}) ${flight.departureCode || ''} → ${flight.arrivalCode || ''}`,
                    'location': flight.arrivalAirportFull || flight.arrivalCity || '',
                    'description': `${fNum} from ${flight.departureCity || ''} to ${flight.arrivalCity || ''}`,
                    'start': { 'dateTime': flight.isoDeparture },
                    'end': { 'dateTime': flight.isoArrival },
                };
                
                const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${gcalToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(event)
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "Google Calendar API rejected the request.");
                }
                addLog(`Successfully synced ${fNum}`);
            };

            const syncAll = async () => {
                if (!gcalToken) return handleGoogleAuth();
                setSyncingAll(true);
                addLog("Starting Sync All process...");
                try {
                    for (const f of flights) {
                        await syncEventToAPI(f);
                    }
                    setStatus({ type: 'success', message: 'All flights synced! ✨' });
                    addLog("Sync All completed successfully.");
                } catch (e) {
                    setStatus({ type: 'error', message: 'Sync failed. Check logs.' });
                    addLog(`Sync All Failed: ${e.message}`);
                } finally {
                    setSyncingAll(false);
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-12 pb-64">
                    <div className="max-w-4xl mx-auto">
                        <header className="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-12 animate-in">
                            <div>
                                <h1 className="text-4xl font-black text-emerald-950 flex items-center gap-4 tracking-tighter">
                                    <span className="p-3 bg-emerald-600 rounded-2xl text-white shadow-xl"><IconPlane /></span> 
                                    Sync Roster
                                </h1>
                            </div>
                            <div className="flex gap-3">
                                {!gcalToken ? (
                                    <button onClick={handleGoogleAuth} className="bg-white border-2 border-emerald-100 text-emerald-700 px-8 py-3 rounded-2xl font-black shadow-sm hover:border-emerald-300 transition-all">
                                        Connect Calendar
                                    </button>
                                ) : (
                                    <div className="bg-emerald-100/50 px-6 py-2.5 rounded-2xl border border-emerald-200 text-xs font-black text-emerald-800 uppercase flex items-center gap-2">
                                        <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                        Calendar Connected
                                    </div>
                                )}
                            </div>
                        </header>

                        <section className="bg-white/60 backdrop-blur-xl rounded-[3rem] shadow-2xl border border-white p-10 mb-10 text-center relative">
                            <div onClick={() => !extracting && fileInputRef.current?.click()} className={`border-4 border-dashed rounded-[2.5rem] p-16 transition-all cursor-pointer ${extracting ? 'bg-emerald-50/50 border-emerald-200 animate-pulse' : 'hover:bg-white hover:border-emerald-400 border-slate-100 bg-slate-50/20'}`}>
                                <input type="file" className="hidden" ref={fileInputRef} accept="image/*" onChange={handleImageUpload} disabled={extracting} />
                                {extracting ? (
                                    <p className="text-2xl font-black text-emerald-900 italic">Reading Roster...</p>
                                ) : (
                                    <div>
                                        <p className="text-3xl font-black text-slate-800 tracking-tighter">Drop Roster Screenshot</p>
                                    </div>
                                )}
                            </div>
                            {status.message && (
                                <div className={`mt-10 p-6 rounded-[2rem] font-bold text-sm text-center border-2 ${status.type === 'error' ? 'bg-red-50 text-red-600 border-red-100' : 'bg-emerald-50 text-emerald-800 border-emerald-100'}`}>
                                    {status.message}
                                </div>
                            )}
                        </section>

                        {flights.length > 0 && (
                            <div className="mb-12 animate-in">
                                {!briefing ? (
                                    <button onClick={generateBriefing} disabled={generatingBrief} className="w-full bg-emerald-950 text-white py-6 rounded-[2.5rem] font-black shadow-2xl hover:bg-black transition-all flex items-center justify-center gap-3 active:scale-[0.98]">
                                        <IconSparkles /> {generatingBrief ? 'Generating...' : 'Generate Monthly Crew Briefing ✨'}
                                    </button>
                                ) : (
                                    <div className="bg-emerald-950 text-emerald-50 rounded-[3rem] p-12 shadow-2xl relative border-4 border-emerald-800">
                                        <h3 className="text-xs font-black uppercase text-emerald-500 mb-8">Monthly Operations Briefing</h3>
                                        <div className="prose prose-invert max-w-none text-emerald-100/90 whitespace-pre-line font-medium leading-relaxed">{briefing}</div>
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="space-y-8 mb-24">
                            {flights.map((f, i) => (
                                <div key={i} className="bg-white rounded-[3rem] shadow-xl border border-slate-100 flex flex-col md:flex-row justify-between md:items-center gap-10 p-12 animate-in overflow-hidden relative">
                                    {/* Fallback Display if AI changes keys again */}
                                    {!f.flightNumber && !f.departureCode && (
                                        <div className="absolute inset-0 bg-red-50/90 p-6 overflow-auto text-xs font-mono text-red-900 z-10">
                                            <p className="font-black text-red-600 uppercase mb-2">RAW AI OUTPUT (Key Mismatch)</p>
                                            {JSON.stringify(f, null, 2)}
                                        </div>
                                    )}
                                    
                                    <div className="flex-1 relative z-0">
                                        <div className="text-5xl font-black text-slate-900 tracking-tighter tabular-nums mb-2">
                                            ({f.flightNumber || "N/A"})
                                        </div>
                                        <div className="text-lg font-bold text-emerald-600/60 uppercase">
                                            {f.departureCode || "---"} → {f.arrivalCode || "---"}
                                        </div>
                                        <div className="mt-10 pt-10 border-t border-slate-50">
                                            {!flightTips[i] ? (
                                                <button onClick={() => getDestinationTip(f, i)} className="text-[10px] font-black uppercase text-emerald-500 flex items-center gap-3">
                                                    <IconSparkles /> Fetch Local Crew Intelligence
                                                </button>
                                            ) : (
                                                <div className="bg-emerald-50/50 p-6 rounded-[2rem] text-xs font-bold text-emerald-800/80 italic">{flightTips[i]}</div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="flex flex-col items-end gap-6 relative z-0">
                                        <div className="text-right">
                                            <div className="text-3xl font-black text-emerald-950 tabular-nums">
                                                {f.departureTime24h || f.departureTimeAMPM || "00:00"}
                                            </div>
                                            <div className="text-[10px] font-black text-slate-300 uppercase mt-2">
                                                {f.arrivalAirportFull || f.arrivalCity || "Unknown Airport"}
                                            </div>
                                        </div>
                                        <button onClick={() => syncEventToAPI(f).then(() => setStatus({type:'success', message: `Synced ${f.flightNumber}!`})).catch(e => setStatus({type:'error', message: e.message}))} className="bg-emerald-600 text-white h-20 w-20 rounded-[2.5rem] flex items-center justify-center shadow-xl active:scale-90 text-3xl">
                                            <IconPlus />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {flights.length > 0 && (
                            <div className="fixed bottom-10 left-0 right-0 px-4 flex justify-center z-50">
                                <button onClick={syncAll} disabled={syncingAll} className="max-w-md w-full bg-emerald-600 text-white py-6 rounded-[3rem] font-black shadow-2xl active:scale-95 text-xl">
                                    {syncingAll ? 'Syncing...' : 'Sync All Flights ✨'}
                                </button>
                            </div>
                        )}
                    </div>

                    {/* DIAGNOSTIC LOGGER UI */}
                    <div className="max-w-4xl mx-auto mt-20 bg-slate-950 rounded-2xl p-6 shadow-2xl border border-slate-800">
                        <div className="flex justify-between items-center mb-4 border-b border-slate-800 pb-2">
                            <h3 className="text-xs font-black uppercase text-emerald-500 tracking-widest">System Logs (Diagnostics)</h3>
                            <span className="text-[10px] text-slate-500 font-mono">v6.0.0</span>
                        </div>
                        <div className="space-y-2 max-h-48 overflow-y-auto font-mono text-xs">
                            {logs.map((log, i) => (
                                <div key={i} className={`${log.includes("ERROR") || log.includes("Failed") || log.includes("Error:") ? "text-red-400" : "text-emerald-400/80"}`}>
                                    {log}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Roster Intelligence</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); }
    </style>
</head>
<body class="bg-emerald-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURATION ---
        // REPLACE THIS with a fresh key from your Google Cloud Console (Credentials page)
        const GEMINI_API_KEY = "AIzaSyAOXzbSBE9X5qsUvUcl6LJ3Uf0jXzXLFyY"; 
        
        // REPLACE THIS with the Client ID shown in your screenshot (starts with 7310...)
        const CLIENT_ID = "724634857433-lf5n8p0noabrpjl90f4f61nr6voqcp5n.apps.googleusercontent.com";
        
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';

        // --- Inline Icons (SVG) to prevent React DOM conflicts ---
        const IconPlane = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>;
        const IconSparkles = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M3 5h4"/><path d="M21 17v4"/><path d="M19 19h4"/></svg>;
        const IconSync = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>;

        function App() {
            const [gcalToken, setGcalToken] = useState(null);
            const [syncingAll, setSyncingAll] = useState(false);
            const [extracting, setExtracting] = useState(false);
            const [generatingBrief, setGeneratingBrief] = useState(false);
            const [flights, setFlights] = useState([]);
            const [status, setStatus] = useState({ type: '', message: '' });
            const [briefing, setBriefing] = useState("");
            const [flightTips, setFlightTips] = useState({});
            
            const fileInputRef = useRef(null);
            const tokenClient = useRef(null);

            useEffect(() => {
                const script = document.createElement('script');
                script.src = "https://accounts.google.com/gsi/client";
                script.async = true;
                script.defer = true;
                script.onload = () => {
                    if (window.google) {
                        try {
                            tokenClient.current = window.google.accounts.oauth2.initTokenClient({
                                client_id: CLIENT_ID,
                                scope: SCOPES,
                                callback: (response) => {
                                    if (response.error !== undefined) {
                                        setStatus({ type: 'error', message: 'Google Auth Error: ' + response.error });
                                        return;
                                    }
                                    setGcalToken(response.access_token);
                                    setStatus({ type: 'success', message: 'Google Calendar Connected!' });
                                },
                            });
                        } catch (err) { console.error("GSI Init Error:", err); }
                    }
                };
                document.body.appendChild(script);
            }, []);

            const handleGoogleAuth = () => {
                if (tokenClient.current) {
                    tokenClient.current.requestAccessToken({ prompt: 'consent' });
                } else {
                    setStatus({ type: 'error', message: 'Google library not ready.' });
                }
            };

            const callGemini = async (promptText, base64Image = null, enforceJSON = false) => {
                // v1beta for robust multimodal scanning
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                
                const parts = [{ text: promptText }];
                if (base64Image) {
                    parts.push({ inlineData: { mimeType: "image/png", data: base64Image } });
                }

                const payload = { contents: [{ parts }] };
                
                // Forces the AI to return raw JSON so it doesn't break the app
                if (enforceJSON) {
                    payload.generationConfig = { responseMimeType: "application/json" };
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "AI Request Failed");
                }
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "";
            };

            const handleImageUpload = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    extractFlightData(base64Data);
                };
                reader.readAsDataURL(file);
            };

            const extractFlightData = async (base64Image) => {
                if (!GEMINI_API_KEY || GEMINI_API_KEY.includes("PASTE")) {
                    setStatus({ type: 'error', message: 'Error: API key missing in code.' });
                    return;
                }
                setExtracting(true);
                setStatus({ type: 'info', message: 'AI is scanning your roster...' });
                setFlights([]);
                setBriefing("");
                
                const prompt = "Extract flight information from this image into a JSON array. RULES: Flight Number (MH 158), Full Arrival Airport Name (e.g. King Abdulaziz International Airport), Departure and Arrival Airport IATA codes, Departure and Arrival Cities, Local times in AMPM format, 24h format times, ISO 8601 Times for departure and arrival including offsets (e.g. +08:00), Short Day name (e.g. Tue), Short Date (e.g. 24th Feb), and UTC offsets. Return ONLY raw JSON.";

                try {
                    let text = await callGemini(prompt, base64Image, true); // true forces JSON
                    text = text.replace(/```json\n?|```/g, "").trim();
                    const parsed = JSON.parse(text);
                    setFlights(Array.isArray(parsed) ? parsed : [parsed]);
                    setStatus({ type: 'success', message: `Found ${Array.isArray(parsed) ? parsed.length : 1} flights!` });
                } catch (error) {
                    setStatus({ type: 'error', message: `Extraction failed: ${error.message}` });
                } finally {
                    setExtracting(false);
                }
            };

            const generateBriefing = async () => {
                setGeneratingBrief(true);
                const prompt = `Provide a short, professional "Monthly Crew Briefing" for these flights: ${JSON.stringify(flights)}. Include timezone shifts, recovery tips, and a monthly health goal.`;
                try {
                    const text = await callGemini(prompt);
                    setBriefing(text);
                } catch (error) {
                    setStatus({ type: 'error', message: "Briefing generation failed." });
                } finally {
                    setGeneratingBrief(false);
                }
            };

            const getDestinationTip = async (flight, index) => {
                setFlightTips(prev => ({ ...prev, [index]: "Thinking... ✨" }));
                const prompt = `Provide 3 quick destination tips for crew arriving at ${flight.arrivalCity} (${flight.arrivalCode}).`;
                try {
                    const text = await callGemini(prompt);
                    setFlightTips(prev => ({ ...prev, [index]: text }));
                } catch (error) {
                    setFlightTips(prev => ({ ...prev, [index]: "Tips unavailable." }));
                }
            };

            const syncEventToAPI = async (flight) => {
                if (!gcalToken) {
                    handleGoogleAuth();
                    throw new Error("Calendar not connected. Re-connect and try again.");
                }
                
                const event = {
                    'summary': `✈️ (${flight.flightNumber}) ${flight.departureCode} → ${flight.arrivalCode}`,
                    'location': flight.arrivalAirportFull || flight.arrivalCity,
                    'description': `${flight.flightNumber} from ${flight.departureCity} to ${flight.arrivalCity}`,
                    'start': { 'dateTime': flight.isoDeparture },
                    'end': { 'dateTime': flight.isoArrival },
                };
                
                const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${gcalToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(event)
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    // Catching the error explicitly so you know why it failed
                    throw new Error(err.error?.message || "Google Calendar rejected the sync. Are you added as a Test User?");
                }
            };

            const syncAll = async () => {
                if (!gcalToken) return handleGoogleAuth();
                setSyncingAll(true);
                try {
                    for (const f of flights) {
                        await syncEventToAPI(f);
                    }
                    setStatus({ type: 'success', message: 'All flights enriched and synced! ✨' });
                } catch (e) {
                    setStatus({ type: 'error', message: e.message });
                } finally {
                    setSyncingAll(false);
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-12">
                    <div className="max-w-4xl mx-auto">
                        <header className="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-12 animate-in">
                            <div>
                                <h1 className="text-4xl font-black text-emerald-950 flex items-center gap-4 tracking-tighter">
                                    <span className="p-3 bg-emerald-600 rounded-2xl text-white shadow-xl shadow-emerald-900/10"><IconPlane /></span> 
                                    Sync Roster Intelligence
                                </h1>
                                <p className="text-[10px] font-black text-emerald-700/50 uppercase tracking-[0.4em] mt-4 flex items-center gap-3">
                                    <span className="w-10 h-[2px] bg-emerald-100"></span>
                                    Next-Gen Crew Operations
                                </p>
                            </div>
                            <div className="flex gap-3">
                                {!gcalToken ? (
                                    <button onClick={handleGoogleAuth} className="bg-white border-2 border-emerald-100 text-emerald-700 px-8 py-3 rounded-2xl font-black shadow-sm hover:border-emerald-300 transition-all flex items-center gap-2">
                                        Connect Calendar
                                    </button>
                                ) : (
                                    <div className="bg-emerald-100/50 px-6 py-2.5 rounded-2xl border border-emerald-200 text-xs font-black text-emerald-800 uppercase tracking-tighter flex items-center gap-2">
                                        <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                        Calendar Connected
                                    </div>
                                )}
                            </div>
                        </header>

                        <section className="bg-white/60 backdrop-blur-xl rounded-[3rem] shadow-2xl shadow-emerald-900/5 border border-white p-10 mb-10 text-center relative overflow-hidden">
                            <div 
                                onClick={() => !extracting && fileInputRef.current?.click()} 
                                className={`border-4 border-dashed rounded-[2.5rem] p-16 transition-all cursor-pointer ${extracting ? 'bg-emerald-50/50 border-emerald-200 animate-pulse' : 'hover:bg-white hover:border-emerald-400 border-slate-100 bg-slate-50/20'}`}
                            >
                                <input type="file" className="hidden" ref={fileInputRef} accept="image/*" onChange={handleImageUpload} disabled={extracting} />
                                {extracting ? (
                                    <p className="text-2xl font-black text-emerald-900 italic tracking-tighter">AI Reading Roster...</p>
                                ) : (
                                    <div>
                                        <p className="text-3xl font-black text-slate-800 tracking-tighter">Drop Roster Screenshot</p>
                                        <p className="text-xs font-bold text-slate-400 mt-3 uppercase tracking-widest">Monthly view PNG or JPG</p>
                                    </div>
                                )}
                            </div>
                            {status.message && (
                                <div className={`mt-10 p-6 rounded-[2rem] font-bold text-sm text-center animate-in border-2 ${status.type === 'error' ? 'bg-red-50 text-red-600 border-red-100' : 'bg-emerald-50 text-emerald-800 border-emerald-100'}`}>
                                    {status.message}
                                </div>
                            )}
                        </section>

                        {flights.length > 0 && (
                            <div className="mb-12 animate-in">
                                {!briefing ? (
                                    <button onClick={generateBriefing} disabled={generatingBrief} className="w-full bg-emerald-950 text-white py-6 rounded-[2.5rem] font-black shadow-2xl hover:bg-black transition-all flex items-center justify-center gap-3 active:scale-[0.98]">
                                        <IconSparkles /> {generatingBrief ? 'Generating intelligence...' : 'Generate Monthly Crew Briefing ✨'}
                                    </button>
                                ) : (
                                    <div className="bg-emerald-950 text-emerald-50 rounded-[3rem] p-12 shadow-2xl relative overflow-hidden border-4 border-emerald-800">
                                        <div className="absolute top-0 right-0 p-10 opacity-5"><IconSparkles /></div>
                                        <h3 className="text-xs font-black uppercase tracking-[0.5em] text-emerald-500 mb-8">Monthly Operations Briefing</h3>
                                        <div className="prose prose-invert max-w-none text-emerald-100/90 whitespace-pre-line font-medium leading-relaxed">{briefing}</div>
                                        <button onClick={() => setBriefing("")} className="mt-8 text-emerald-500/40 hover:text-emerald-500 text-[10px] font-black uppercase tracking-widest flex items-center gap-2">
                                            <IconSync /> Regenerate
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="space-y-8 mb-24">
                            {flights.length > 0 && <h2 className="text-[10px] font-black uppercase tracking-[0.4em] text-emerald-900/30 px-6">Validated Itinerary Preview</h2>}
                            {flights.map((f, i) => (
                                <div key={i} className="bg-white rounded-[3rem] shadow-xl shadow-emerald-950/5 border border-slate-100 flex flex-col md:flex-row justify-between md:items-center gap-10 p-12 animate-in transition-all hover:shadow-2xl hover:-translate-y-1" style={{animationDelay: `${i * 0.1}s`}}>
                                    <div className="flex-1">
                                        <div className="inline-block px-4 py-1.5 bg-emerald-50 text-emerald-600 rounded-xl text-[10px] font-black uppercase tracking-widest mb-4">Sector {i+1}</div>
                                        <div className="text-5xl font-black text-slate-900 tracking-tighter tabular-nums mb-2">({f.flightNumber})</div>
                                        <div className="text-lg font-bold text-emerald-600/60 uppercase tracking-tighter">{f.departureCode} → {f.arrivalCode}</div>
                                        
                                        <div className="mt-10 pt-10 border-t border-slate-50">
                                            {!flightTips[i] ? (
                                                <button onClick={() => getDestinationTip(f, i)} className="text-[10px] font-black uppercase tracking-widest text-emerald-500 flex items-center gap-3 hover:text-emerald-950 transition-all">
                                                    <IconSparkles /> Fetch Local Crew Intelligence
                                                </button>
                                            ) : (
                                                <div className="bg-emerald-50/50 p-6 rounded-[2rem] text-xs font-bold text-emerald-800/80 leading-relaxed italic animate-in">
                                                    {flightTips[i]}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="flex flex-col items-end gap-6">
                                        <div className="text-right">
                                            <div className="text-3xl font-black text-emerald-950 tabular-nums">{f.departureTime24h || f.departureTimeAMPM} — {f.arrivalTime24h || f.arrivalTimeAMPM}</div>
                                            <div className="text-[10px] font-black text-slate-300 uppercase mt-2 tracking-widest">{f.arrivalAirportFull}</div>
                                        </div>
                                        <button 
                                            onClick={() => syncEventToAPI(f).then(() => setStatus({type:'success', message: `Successfully synced ${f.flightNumber}`})).catch(e => setStatus({type: 'error', message: e.message}))}
                                            className="bg-emerald-600 text-white h-20 w-20 rounded-[2.5rem] flex items-center justify-center shadow-xl shadow-emerald-200 active:scale-90 transition-all text-3xl"
                                        >
                                            <IconPlus />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {flights.length > 0 && (
                            <div className="fixed bottom-10 left-0 right-0 px-4 flex justify-center z-50">
                                <button onClick={syncAll} disabled={syncingAll} className="max-w-md w-full bg-emerald-600 text-white py-6 rounded-[3rem] font-black shadow-2xl shadow-emerald-950/20 hover:bg-emerald-700 transition-all active:scale-95 text-xl flex items-center justify-center gap-4">
                                    <IconSync /> {syncingAll ? 'Intelligently Syncing...' : 'Sync All Flights ✨'}
                                </button>
                            </div>
                        )}
                        
                        <footer className="mt-20 text-center pb-20">
                            <p className="text-[10px] font-black text-emerald-900/10 uppercase tracking-[1em]">Intelligence System v5.3.0</p>
                        </footer>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


